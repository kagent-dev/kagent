# Main Agent - uses tools through proxy gateway
apiVersion: kagent.dev/v1alpha2
kind: Agent
metadata:
  name: proxy-test-agent
  namespace: kagent
spec:
  type: Declarative
  declarative:
    modelConfig: proxy-test-model-config
    systemMessage: You are a test agent that uses tools through a proxy gateway.
    deployment:
      imagePullPolicy: Always
      env:
      - name: LOG_LEVEL
        value: DEBUG
    tools:
    - type: Agent
      agent:
        name: target-agent-proxy-test
    - type: McpServer
      mcpServer:
        apiGroup: kagent.dev
        kind: MCPServer
        name: everything-mcp-server
        toolNames:
        - get-sum
    - type: McpServer
      mcpServer:
        kind: Service
        name: test-mcp-service
        toolNames:
        - get-sum
---
# Gateway for proxy testing
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: proxy
  namespace: kagent
spec:
  gatewayClassName: agentgateway
  listeners:
  - name: http
    port: 8080
    protocol: HTTP
---
# Service as MCP Tool - points to MCPServer backend
apiVersion: v1
kind: Service
metadata:
  name: test-mcp-service
  namespace: kagent
  annotations:
    kagent.dev/mcp-service-port: "3000"
    kagent.dev/mcp-service-path: "/mcp"
    kagent.dev/mcp-service-protocol: "streamable-http"
spec:
  ports:
  - name: mcp
    port: 3000
    targetPort: 3000
    protocol: TCP
    appProtocol: mcp
  selector:
    app.kubernetes.io/name: everything-mcp-server
---
# HTTPRoute for MCPServer
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mcpserver-route
  namespace: kagent
spec:
  parentRefs:
  - name: proxy
    namespace: kagent
  rules:
  - matches:
    - headers:
      - type: Exact
        name: x-kagent-host
        value: everything-mcp-server.kagent
    backendRefs:
    - name: everything-mcp-server
      port: 3000
---
# HTTPRoute for Service
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: service-route
  namespace: kagent
spec:
  parentRefs:
  - name: proxy
    namespace: kagent
  rules:
  - matches:
    - headers:
      - type: Exact
        name: x-kagent-host
        value: test-mcp-service.kagent
    backendRefs:
    - name: test-mcp-service
      port: 3000
---
# Target Agent for agent-to-agent testing through proxy
apiVersion: kagent.dev/v1alpha2
kind: Agent
metadata:
  name: target-agent-proxy-test
  namespace: kagent
spec:
  type: Declarative
  declarative:
    modelConfig: proxy-test-model-config
    systemMessage: You are a target agent that responds to requests through the proxy.
    deployment:
      imagePullPolicy: Always
      env:
      - name: LOG_LEVEL
        value: DEBUG
---
# HTTPRoute for Target Agent
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: target-agent-route
  namespace: kagent
spec:
  parentRefs:
  - name: proxy
    namespace: kagent
  rules:
  - matches:
    - headers:
      - type: Exact
        name: x-kagent-host
        value: target-agent-proxy-test.kagent
    backendRefs:
    - name: target-agent-proxy-test
      port: 8080
